---
title: "Regression Analysis"
always_allow_html: true
output: 
  html_document:
    toc: true
    code_folding: hide
    toc_float: true
--- 

```{r,include=FALSE,message=FALSE,echo=FALSE}
library(tidyverse)
library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)
library(kableExtra)
library(modelr)
library(mgcv)
library(magick)
library(readr)
library(gifski)

knitr::opts_chunk$set(
echo = FALSE,
fig.width = 7,
fig.height = 5,
fig.asp = 0.6,
out.width = "60%")
theme_set(theme_bw() +
         theme(legend.position = "bottom",
               legend.title = element_blank(),
               plot.title = element_text(hjust = 0.5, size = 15),
               plot.subtitle = element_text(hjust = 0.5, size = 12)))

maindata = read_csv("data/maindata.csv") 
```


#### Create "mortality_per_100k" and "log_mortality_per_100k" variables

**maindata** has `r nrow(maindata)` observations and `r ncol(maindata)` features. We are adjusting for population size by dividing  `val` (point estimate of number of HIV/AIDS deaths) by `population` multiplied by 100,000 to get a `mortality_per_100k` variable and a `log_mortality_per_100k` variable.

```{r, echo=TRUE, message = FALSE,warning = FALSE}
regression = maindata %>% 
  mutate(mortality_per_100k = val / (population/100000),
         log_mortality_per_100k = log(mortality_per_100k),
         year_2004 = if_else(year <= 2004, 1, 0),
         year_2004 = as.factor(year_2004),
         country_name = as.factor(country_name)) 
regression %>% 
  summarize(col_name = colnames(regression),
            n_missing = map(regression, ~sum(is.na(.)))) %>% 
  unnest(n_missing)
```

### Plots of the distribution to main outcome of interest(HIV mortality per 100k population).

First, we plot the distribution of `mortality_per_100k`. We can see that we need to transform it to satisfy the normality assumption. So we used a log transformation to get a more normal distribution, and have a new variable `mortality_per_100k`.

```{r, echo=TRUE, message = FALSE,warning = FALSE}
regression %>%
 ggplot(aes(x = mortality_per_100k)) +
 geom_histogram(color = "darkblue", fill = "lightblue") +
 ggtitle("Histogram of HIV deaths per 100k") +
 geom_vline( aes(xintercept = mean(mortality_per_100k)),
            linetype = "dashed") +
 ylab("") +
 xlab("Estimated HIV deaths per 100k")

regression %>%
 ggplot(aes(x = log_mortality_per_100k)) +
 geom_histogram(color = "darkblue", fill = "lightblue") +
 ggtitle("Histogram of log(HIV deaths per 100k)") +
 geom_vline(aes(xintercept = mean(log_mortality_per_100k)),
            linetype = "dashed") +
 ylab("") +
 xlab("Estimated log(HIV deaths per 100k)")
```

## Regression models

Now we proceed with building different regression models.

### Logistic regression models

#### model1:

$$ log(mortality/100000) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year + \beta_4 gdp $$
```{r, echo=TRUE}
regression_logit = regression %>%
  mutate(log_mortality_per_100k = if_else(log_mortality_per_100k == -Inf, 0.01, log_mortality_per_100k))
  
model1_logit = lm(log_mortality_per_100k ~ age_name + sex_name + year + gdp_per_capita, data = regression_logit) 
kable(summary(model1_logit)$coefficients)
```

#### model2:

$$ log(mortality/100000) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year + \beta_4year_{2004} + \beta_5gdp + \beta_6 year*year_{2004}  $$
```{r, echo=TRUE}
  
model2_logit = lm(log_mortality_per_100k ~ age_name + sex_name + year + year_2004 + gdp_per_capita + year*year_2004, data = regression_logit)
kable(summary(model2_logit)$coefficients)
```

#### model3:

$$ log(mortality/100000) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year_{2004} + \beta_4 gdp + \beta_5 age*sex $$

```{r, echo=TRUE}
model3_logit = lm(log_mortality_per_100k ~ age_name + sex_name + year_2004 + gdp_per_capita + age_name*sex_name, data = regression_logit)
kable(summary(model3_logit)$coefficients)
```

#### model4:
$$ log(mortality/100000) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year_{2004} + \beta_4 gdp + \beta_5 age*sex + \beta_6 country$$

```{r, echo=TRUE}
model4_logit = lm(log_mortality_per_100k ~ age_name + sex_name + year_2004 + gdp_per_capita + age_name*sex_name + country_name, data = regression_logit)
kable(summary(model4_logit)$coefficients)
```

### Poisson Regression models

#### model1:

$$ log(E(Y_i|age_i,sex_i,year_i,gdp_i)) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year + \beta_4 gdp $$
```{r, echo=TRUE}
regression_poisson = regression %>% 
  mutate(val = as.integer(val))
model1_poi = glm(val ~ age_name + sex_name + year + gdp_per_capita, family = "poisson", data = regression_poisson)
kable(summary(model1_poi)$coefficients)
```
#### model2:

$$ log(E(Y_i|age_i,sex_i,year_i,year_{2004i},gdp_i)) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year + \beta_4 year_{2004} + \beta_5 gdp + \beta_6 year *year_{2004}$$
```{r, echo=TRUE}
model2_poi = glm(val ~ age_name + sex_name + year + year_2004 + gdp_per_capita + year*year_2004, family = "poisson", data = regression_poisson)
kable(summary(model2_poi)$coefficients)
```

#### model3:

$$ log(E(Y_i|age_i,sex_i,year_{2004i},gdp_i)) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year_{2004} + \beta_4 gdp + \beta_5 age *sex$$
```{r, echo=TRUE}
model3_poi = glm(val ~ age_name + sex_name + year_2004 + gdp_per_capita + age_name*sex_name, data = regression_poisson)
kable(summary(model3_logit)$coefficients)
```

#### model4:

$$ log(E(Y_i|age_i,sex_i,year_{2004i},gdp_i,country_i)) = \beta_0 + \beta_1 age + \beta_2 sex + \beta_3 year_{2004} + \beta_4 gdp + \beta_5 age *sex + \beta_6 country$$
```{r, echo=TRUE}
model4_logit = glm(val ~ age_name + sex_name + year_2004 + gdp_per_capita + age_name*sex_name + country_name, data = regression_poisson)
kable(summary(model4_logit)$coefficients)
```